#!/bin/sh

if ! whoami &> /dev/null; then
  if [ -w /etc/passwd ]; then
    echo "Setting runtime User ... "
    echo "${USER_NAME:-git}:x:$(id -u):0:${USER_NAME:-git} user:${HOME}:/bin/sh" >> /etc/passwd
    sed -i 's/ID_USER/'"$(id -u)"'/g' /assets/gitlab.rb
    chmod -R a+rwx ${APP_HOME}
    chown -R $(id -u):0 ${APP_HOME}
    chmod -R a+rwx ${HOME}
    chown -R $(id -u):0 ${HOME}
  fi
fi
exec "$@"
